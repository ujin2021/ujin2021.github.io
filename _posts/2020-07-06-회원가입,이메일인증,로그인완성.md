---
title: "프로젝트 회원가입, 이메일인증, 로그인 완성"
date: 2020-07-06 22:55:00 -0400
categories: django server python project drf SMTP
---
회원가입, 이메일인증, 로그인까지 하는데 너무 어려움이 많았다.

일단 먼저 알아본것은 django-rest-auth 라고 많은 endpoint들을 제공해주는 것이다.<br>
우리 회원가입에는 email, password, username만 사용하면 되기때문에 기본 django에서 제공해주는 user모델을 사용하려고 했다.<br>
찾아보니 rest-auth에서 registration, login, logout, 패스워드변경, 심지어 이번프로젝트에서 필요한 email-verify endpoint도 제공해주었다.<br>
하지만 이메일 인증 전, is_active 가 false여야 하고, 이메일 인증 후 is_active가 true가 되도록 바꾸어야 했는데, 아무리 설정해도 처음 회원가입시 is_active가 True로 되었다..ㅜㅜ<br>
그리고 models.py에 따로 정의해주는게 없으니 모델을 유연하게 관리하는것이 힘들었다.(물론 나의 실력이 부족했기때문일것이다..)<br>
rest-auth공식홈페이지에서도 endpoint만 설명하고, signup, login예제들은 많이 있었지만 이후 이메일 인증에 관해 참고할만한 자료들이 없었다...<br>
몇번을 views.py 와 serializers.py를 갈아엎은 후 그냥 원래대로 하기로했다...(나중에 구글로그인이나 페이스북 로그인 구현할때는 rest-auth가 사용된다!)<br>
models.py에 필요한 username, email, password, is_active(이후 더 추가될수도 있음!)을 설정해놓았다. 여기서 문제가 django에서 제공해주는 user모델은 password를 자동으로 암호화하여 db에 저장해준다(아마도..?)<br>
내가 임의로 모델에 password를 지정해주면 내가 따로 post로 받아온 후 암호화를 해주어야 한다. 전 xproject에서도 이것을 하려고했지만 실패했다. 하지만 예상외로 쉬운 방법을 발견했다!<br>
<br>
import bcrypt
password = bcrypt.hashpw(data['password'].encode("UTF-8"), bcrypt.gensalt()).decode("UTF-8")
<br>
이러한 형식으로 저장해주면 된다. 물론 login때도 이런식으로 비교해주어야한다! import bcrypt를 사용하려면 pip로 install 해주어야한다.<br>
$ pip install bcrypt<br>

나머지 post로 받아오는 기본적인 signup, login코드들과 serializers.py, urls.py는 이전 xproject와 동일하게 했다.<br>
post를 보낼때 사용한 프로그램은 insomnia이다. 매번 앱을 연결해서 하기엔 번거로우니까 간단하게 테스트 해볼 수 있는 프로그램이다.<br>
사용법도 간단하다. insomnia를 다운받고 POST를 골라준 뒤, url을 적고 json형식으로 적어서 send만 눌러주면된다 너무너무유용한 프로그램..!!<br>

이메일인증은 smtp 프로토콜을 사용한다. shell에서 먼저 보내볼수있다! <br>
다행히 로그인까지 잘되어 다행이다.. 로그인 할 때 토큰생성이나 위에서 말한 비밀번호 암호화, settings.py분리하는 것(google계정의 비밀번호를 저장해야해서 꼭 github올릴때 mysettings.py등등으로 분리해주고 gitingnore로 로컬에서만 저장해놓아야 한다!!)등등 은 사이트를 참고해서 했다.<br>
참고한 사이트 : https://wave1994.tistory.com/100 (정말 나에게 큰 도움을 주셨다...!!ㅠㅠ)<br>

이메일 인증시 메일내용에 인증링크를 첨부하는데, <br>
회원가입 링크 : http://{domain}/accounts/activate/{uidb64}/{token} 이런식으로<br>
여기서 그냥 domain을 domain = current_site.domain 이렇게 받아주었더니 example.com이 domain에 들어갔다.(현재는 localhost로 접속하기때문에 localhost:8000으로 뜰줄알았는데..)<br>
알아보니 admin site에서 sites의 example.com을 127.0.0.1로 변경해주면 현재 domain이 sites에 저장해준 링크로 들어간다(아직 앱으로 접속해보지 않아서 앱연결시 잘 될지는 모르겠다..)

django 를 하면서 느끼지만 아직 부족한점이 너무많다. 토큰과 암호화 등등 내가 직접 코드에 기여한 느낌이 아니라 그냥 보고 따라하는 느낌...ㅠㅠ<br>
